import { ConvertToMarkerResult } from "./models/convert-to-marker-result";
import { ADDEndMarker } from "./models/markers/add-end-marker";
import { ADDMarker } from "./models/markers/add-marker";
import { BMarker } from "./models/markers/b-marker";
import { BDEndMarker } from "./models/markers/bd-end-marker";
import { BDMarker } from "./models/markers/bd-marker";
import { BDITEndMarker } from "./models/markers/bdit-end-marker";
import { BDITMarker } from "./models/markers/bdit-marker";
import { BKEndMarker } from "./models/markers/bk-end-marker";
import { BKMarker } from "./models/markers/bk-marker";
import { CMarker } from "./models/markers/c-marker";
import { CAEndMarker } from "./models/markers/ca-end-marker";
import { CAMarker } from "./models/markers/ca-marker";
import { CLMarker } from "./models/markers/cl-marker";
import { CLSMarker } from "./models/markers/cls-marker";
import { CPMarker } from "./models/markers/cp-marker";
import { DMarker } from "./models/markers/d-marker";
import { EMEndMarker } from "./models/markers/em-end-marker";
import { EMMarker } from "./models/markers/em-marker";
import { FEndMarker } from "./models/markers/f-end-marker";
import { FMarker } from "./models/markers/f-marker";
import { FIGEndMarker } from "./models/markers/fig-end-marker";
import { FIGMarker } from "./models/markers/fig-marker";
import { FKMarker } from "./models/markers/fk-marker";
import { FPMarker } from "./models/markers/fp-marker";
import { FQEndMarker } from "./models/markers/fq-end-marker";
import { FQMarker } from "./models/markers/fq-marker";
import { FQAEndMarker } from "./models/markers/fqa-end-marker";
import { FQAMarker } from "./models/markers/fqa-marker";
import { FREndMarker } from "./models/markers/fr-end-marker";
import { FRMarker } from "./models/markers/fr-marker";
import { FTMarker } from "./models/markers/ft-marker";
import { FVEndMarker } from "./models/markers/fv-end-marker";
import { FVMarker } from "./models/markers/fv-marker";
import { HMarker } from "./models/markers/h-marker";
import { IBMarker } from "./models/markers/ib-marker";
import { IDMarker } from "./models/markers/id-marker";
import { IDEMarker } from "./models/markers/ide-marker";
import { IEMarker } from "./models/markers/ie-marker";
import { ILIMarker } from "./models/markers/ili-marker";
import { IMMarker } from "./models/markers/im-marker";
import { IMIMarker } from "./models/markers/imi-marker";
import { IMQMarker } from "./models/markers/imq-marker";
import { IMTMarker } from "./models/markers/imt-marker";
import { IOMarker } from "./models/markers/io-marker";
import { IOREndMarker } from "./models/markers/ior-end-marker";
import { IORMarker } from "./models/markers/ior-marker";
import { IOTMarker } from "./models/markers/iot-marker";
import { IPMarker } from "./models/markers/ip-marker";
import { IPIMarker } from "./models/markers/ipi-marker";
import { IPQMarker } from "./models/markers/ipq-marker";
import { IPRMarker } from "./models/markers/ipr-marker";
import { IQMarker } from "./models/markers/iq-marker";
import { ISMarker } from "./models/markers/is-marker";
import { ITEndMarker } from "./models/markers/it-end-marker";
import { ITMarker } from "./models/markers/it-marker";
import { KEndMarker } from "./models/markers/k-end-marker";
import { KMarker } from "./models/markers/k-marker";
import { LFMarker } from "./models/markers/lf-marker";
import { LIMarker } from "./models/markers/li-marker";
import { LIKEndMarker } from "./models/markers/lik-end-marker";
import { LIKMarker } from "./models/markers/lik-marker";
import { LITLEndMarker } from "./models/markers/litl-end-marker";
import { LITLMarker } from "./models/markers/litl-marker";
import { LIVEndMarker } from "./models/markers/liv-end-marker";
import { LIVMarker } from "./models/markers/liv-marker";
import { MMarker } from "./models/markers/m-marker";
import { Marker } from "./models/markers/marker";
import { MIMarker } from "./models/markers/mi-marker";
import { MRMarker } from "./models/markers/mr-marker";
import { MSMarker } from "./models/markers/ms-marker";
import { MTMarker } from "./models/markers/mt-marker";
import { NBMarker } from "./models/markers/nb-marker";
import { NDEndMarker } from "./models/markers/nd-end-marker";
import { NDMarker } from "./models/markers/nd-marker";
import { NOEndMarker } from "./models/markers/no-end-marker";
import { NOMarker } from "./models/markers/no-marker";
import { ORDEndMarker } from "./models/markers/ord-end-marker";
import { ORDMarker } from "./models/markers/ord-marker";
import { PMarker } from "./models/markers/p-marker";
import { PCMarker } from "./models/markers/pc-marker";
import { PIMarker } from "./models/markers/pi-marker";
import { PMCMarker } from "./models/markers/pmc-marker";
import { PMOMarker } from "./models/markers/pmo-marker";
import { PMRMarker } from "./models/markers/pmr-marker";
import { PNEndMarker } from "./models/markers/pn-end-marker";
import { PNMarker } from "./models/markers/pn-marker";
import { PNGEndMarker } from "./models/markers/png-end-marker";
import { PNGMarker } from "./models/markers/png-marker";
import { PRMarker } from "./models/markers/pr-marker";
import { PROEndMarker } from "./models/markers/pro-end-marker";
import { PROMarker } from "./models/markers/pro-marker";
import { QMarker } from "./models/markers/q-marker";
import { QAMarker } from "./models/markers/qa-marker";
import { QACEndMarker } from "./models/markers/qac-end-marker";
import { QACMarker } from "./models/markers/qac-marker";
import { QCMarker } from "./models/markers/qc-marker";
import { QDMarker } from "./models/markers/qd-marker";
import { QMMarker } from "./models/markers/qm-marker";
import { QRMarker } from "./models/markers/qr-marker";
import { QSEndMarker } from "./models/markers/qs-end-marker";
import { QSMarker } from "./models/markers/qs-marker";
import { QTEndMarker } from "./models/markers/qt-end-marker";
import { QTMarker } from "./models/markers/qt-marker";
import { RMarker } from "./models/markers/r-marker";
import { RBEndMarker } from "./models/markers/rb-end-marker";
import { RBMarker } from "./models/markers/rb-marker";
import { REMMarker } from "./models/markers/rem-marker";
import { RQEndMarker } from "./models/markers/rq-end-marker";
import { RQMarker } from "./models/markers/rq-marker";
import { SMarker } from "./models/markers/s-marker";
import { SCEndMarker } from "./models/markers/sc-end-marker";
import { SCMarker } from "./models/markers/sc-marker";
import { SIGEndMarker } from "./models/markers/sig-end-marker";
import { SIGMarker } from "./models/markers/sig-marker";
import { SLSEndMarker } from "./models/markers/sls-end-marker";
import { SLSMarker } from "./models/markers/sls-marker";
import { SPMarker } from "./models/markers/sp-marker";
import { STSMarker } from "./models/markers/sts-marker";
import { SUPEndMarker } from "./models/markers/sup-end-marker";
import { SUPMarker } from "./models/markers/sup-marker";
import { TableBlock } from "./models/markers/table-block";
import { TCMarker } from "./models/markers/tc-marker";
import { TCRMarker } from "./models/markers/tcr-marker";
import { TextBlock } from "./models/markers/text-block";
import { THMarker } from "./models/markers/th-marker";
import { THRMarker } from "./models/markers/thr-marker";
import { TLEndMarker } from "./models/markers/tl-end-marker";
import { TLMarker } from "./models/markers/tl-marker";
import { TOC1Marker } from "./models/markers/toc1-marker";
import { TOC2Marker } from "./models/markers/toc2-marker";
import { TOC3Marker } from "./models/markers/toc3-marker";
import { TOCA1Marker } from "./models/markers/toca1-marker";
import { TOCA2Marker } from "./models/markers/toca2-marker";
import { TOCA3Marker } from "./models/markers/toca3-marker";
import { TRMarker } from "./models/markers/tr-marker";
import { UnknownMarker } from "./models/markers/unknown-marker";
import { USFMDocument } from "./models/markers/usfm-document";
import { USFMMarker } from "./models/markers/usfm-marker";
import { VMarker } from "./models/markers/v-marker";
import { VAEndMarker } from "./models/markers/va-end-marker";
import { VAMarker } from "./models/markers/va-marker";
import { VPEndMarker } from "./models/markers/vp-end-marker";
import { VPMarker } from "./models/markers/vp-marker";
import { WEndMarker } from "./models/markers/w-end-marker";
import { WMarker } from "./models/markers/w-marker";
import { WAEndMarker } from "./models/markers/wa-end-marker";
import { WAMarker } from "./models/markers/wa-marker";
import { WGEndMarker } from "./models/markers/wg-end-marker";
import { WGMarker } from "./models/markers/wg-marker";
import { WHEndMarker } from "./models/markers/wh-end-marker";
import { WHMarker } from "./models/markers/wh-marker";
import { WJEndMarker } from "./models/markers/wj-end-marker";
import { WJMarker } from "./models/markers/wj-marker";
import { XEndMarker } from "./models/markers/x-end-marker";
import { XMarker } from "./models/markers/x-marker";
import { XOMarker } from "./models/markers/xo-marker";
import { XQMarker } from "./models/markers/xq-marker";
import { XTMarker } from "./models/markers/xt-marker";

export class USFMParser {
  /** @var array|string[] */
  private ignoredTags: string[] = [];
  private ignoreUnknownMarkers: boolean = false;
  private static splitRegex: RegExp = /\\([a-z0-9-]*\**)([^\\]*)/g;

  /**
   * @param ?string[] $tagsToIgnore
   * @param bool $ignoreUnknownMarkers
   */
  constructor(
    tagsToIgnore: string[] | null = null,
    ignoreUnknownMarkers: boolean = false
  ) {
    this.ignoredTags = tagsToIgnore ?? [];
    this.ignoreUnknownMarkers = ignoreUnknownMarkers;
  }

  /**
   * Parses a string into a USFMDocument
   * @param string $input A USFM string
   * @return USFMDocument A USFMDocument representing the input
   */
  public parseFromString(input: string): USFMDocument {
    const output = new USFMDocument();
    let markers = this.tokenizeFromString(input);

    // Clean out extra whitespace where it isn't needed
    markers = this.cleanWhitespace(markers);

    for (let markerIndex = 0; markerIndex < markers.length; markerIndex++) {
      const marker = markers[markerIndex];
      if (
        marker instanceof TRMarker &&
        !output.getTypesPathToLastMarker().includes(TableBlock)
      ) {
        output.insert(new TableBlock());
      }

      if (
        marker instanceof QMarker &&
        markerIndex !== markers.length - 1 &&
        markers[markerIndex + 1] instanceof VMarker
      ) {
        (marker as QMarker).isPoetryBlock = true;
        output.insert(marker);
      } else {
        output.insert(marker);
      }
    }

    return output;
  }

  /**
   * Removes all the unnecessary whitespace while preserving space between closing markers and opening markers
   * @param (Marker|USFMDocument)[] $input
   * @return (Marker|USFMDocument)[]
   */
  private cleanWhitespace(
    input: (Marker | USFMDocument)[]
  ): (Marker | USFMDocument)[] {
    /** @var Marker[] $output */
    const output: (Marker | USFMDocument)[] = [];

    for (let index = 0; index < input.length; index++) {
      const block = input[index];
      if (!(block instanceof TextBlock && !block.text.trim())) {
        output.push(block);
        continue;
      }

      // If this is an empty text block at the beginning remove it
      if (index === 0) {
        continue;
      }

      // If this is an empty text block at the end then remove it
      if (index === input.length - 1) {
        continue;
      }

      // If this isn't between and end marker and another marker then delete it
      const prev = input[index - 1];
      const next = input[index + 1];
      if (
        !(
          prev.getIdentifier().endsWith("*") &&
          !next.getIdentifier().endsWith("*")
        )
      ) {
        continue;
      }

      output.push(input[index]);
    }
    return output;
  }

  /**
   * Generate a list of Markers from a string
   * @param string $input USFM String to tokenize
   * @return (Marker|USFMDocument)[] A List of Markers based upon the string
   */
  private tokenizeFromString(input: string): (Marker | USFMDocument)[] {
    /** @var Marker[] $output */
    const output: (Marker | USFMDocument)[] = [];
    const matches = Array.from(input.matchAll(USFMParser.splitRegex));

    for (const match of matches) {
      if (this.ignoredTags.includes(match[1])) {
        continue;
      }

      const result = this.convertToMarker(match[1], match[2]);
      const resultMarker = result.marker;
      if (resultMarker instanceof Marker) {
        resultMarker.position = matches.indexOf(match);
      }

      // If this is an unknown marker, and we're in Ignore Unknown Marker mode then don't add the marker.
      // We still keep any remaining text though
      if (resultMarker instanceof UnknownMarker) {
        if (this.ignoreUnknownMarkers) {
          output.push(new TextBlock(resultMarker.parsedValue));
        } else {
          output.push(resultMarker);
        }
      } else {
        output.push(resultMarker);
      }

      if (result.remainingText && result.remainingText.trim()) {
        output.push(new TextBlock(result.remainingText));
      }
    }

    return output;
  }

  /**
   * @param string $identifier
   * @param string $value
   * @return ConvertToMarkerResult
   */
  private convertToMarker(
    identifier: string,
    value: string
  ): ConvertToMarkerResult {
    const output = this.selectMarker(identifier);
    const remainingText = output.preProcess(value);

    return { marker: output, remainingText };
  }

  /**
   * @param string $identifier
   * @return Marker
   */
  private selectMarker(identifier: string): Marker | USFMDocument {
    switch (identifier) {
      case "id":
        return new IDMarker();
      case "ide":
        return new IDEMarker();
      case "sts":
        return new STSMarker();
      case "h":
        return new HMarker();
      case "toc1":
        return new TOC1Marker();
      case "toc2":
        return new TOC2Marker();
      case "toc3":
        return new TOC3Marker();
      case "toca1":
        return new TOCA1Marker();
      case "toca2":
        return new TOCA2Marker();
      case "toca3":
        return new TOCA3Marker();

      /* Introduction Markers*/
      case "imt":
      case "imt1":
        return new IMTMarker();
      case "imt2":
        const imt2Marker = new IMTMarker();
        imt2Marker.weight = 2;
        return imt2Marker;
      case "imt3":
        const imt3Marker = new IMTMarker();
        imt3Marker.weight = 3;
        return imt3Marker;
      case "is":
      case "is1":
        return new ISMarker();
      case "is2":
        const is2Marker = new ISMarker();
        is2Marker.weight = 2;
        return is2Marker;
      case "is3":
        const is3Marker = new ISMarker();
        is3Marker.weight = 3;
        return is3Marker;
      case "ib":
        return new IBMarker();
      case "iq":
      case "iq1":
        return new IQMarker();
      case "iq2":
        const iq2Marker = new IQMarker();
        iq2Marker.depth = 2;
        return iq2Marker;
      case "iq3":
        const iq3Marker = new IQMarker();
        iq3Marker.depth = 3;
        return iq3Marker;
      case "iot":
        return new IOTMarker();
      case "io":
      case "io1":
        return new IOMarker();
      case "io2":
        const io2Marker = new IOMarker();
        io2Marker.depth = 2;
        return io2Marker;
      case "io3":
        const io3Marker = new IOMarker();
        io3Marker.depth = 3;
        return io3Marker;
      case "ior":
        return new IORMarker();
      case "ior*":
        return new IOREndMarker();
      case "ili":
      case "ili1":
        return new ILIMarker();
      case "ili2":
        const ili2Marker = new ILIMarker();
        ili2Marker.depth = 2;
        return ili2Marker;
      case "ili3":
        const ili3Marker = new ILIMarker();
        ili3Marker.depth = 3;
        return ili3Marker;
      case "ip":
        return new IPMarker();
      case "ipi":
        return new IPIMarker();
      case "im":
        return new IMMarker();
      case "imi":
        return new IMIMarker();
      case "ipq":
        return new IPQMarker();
      case "imq":
        return new IMQMarker();
      case "ipr":
        return new IPRMarker();
      case "mt":
      case "mt1":
        return new MTMarker();
      case "mt2":
        const mt2Marker = new MTMarker();
        mt2Marker.weight = 2;
        return mt2Marker;
      case "mt3":
        const mt3Marker = new MTMarker();
        mt3Marker.weight = 3;
        return mt3Marker;
      case "c":
        return new CMarker();
      case "cp":
        return new CPMarker();
      case "ca":
        return new CAMarker();
      case "ca*":
        return new CAEndMarker();
      case "p":
        return new PMarker();
      case "v":
        return new VMarker();
      case "va":
        return new VAMarker();
      case "va*":
        return new VAEndMarker();
      case "vp":
        return new VPMarker();
      case "vp*":
        return new VPEndMarker();
      case "q":
      case "q1":
        return new QMarker();
      case "q2":
        const q2Marker = new QMarker();
        q2Marker.depth = 2;
        return q2Marker;
      case "q3":
        const q3Marker = new QMarker();
        q3Marker.depth = 3;
        return q3Marker;
      case "q4":
        const q4Marker = new QMarker();
        q4Marker.depth = 4;
        return q4Marker;
      case "qr":
        return new QRMarker();
      case "qc":
        return new QCMarker();
      case "qd":
        return new QDMarker();
      case "qac":
        return new QACMarker();
      case "qac*":
        return new QACEndMarker();
      case "qm":
      case "qm1":
        return new QMMarker();
      case "qm2":
        const qm2Marker = new QMMarker();
        qm2Marker.depth = 2;
        return qm2Marker;
      case "qm3":
        const qm3Marker = new QMMarker();
        qm3Marker.depth = 3;
        return qm3Marker;

      case "m":
        return new MMarker();
      case "d":
        return new DMarker();
      case "ms":
      case "ms1":
        return new MSMarker();
      case "ms2":
        const ms2Marker = new MSMarker();
        ms2Marker.weight = 2;
        return ms2Marker;
      case "ms3":
        const ms3Marker = new MSMarker();
        ms3Marker.weight = 3;
        return ms3Marker;
      case "mr":
        return new MRMarker();
      case "cl":
        return new CLMarker();
      case "qs":
        return new QSMarker();
      case "qs*":
        return new QSEndMarker();
      case "f":
        return new FMarker();
      case "fp":
        return new FPMarker();
      case "qa":
        return new QAMarker();
      case "nb":
        return new NBMarker();
      case "fqa":
        return new FQAMarker();
      case "fqa*":
        return new FQAEndMarker();
      case "fq":
        return new FQMarker();
      case "fq*":
        return new FQEndMarker();
      case "pi":
      case "pi1":
        return new PIMarker();
      case "pi2":
        const pi2Marker = new PIMarker();
        pi2Marker.depth = 2;
        return pi2Marker;
      case "pi3":
        const pi3Marker = new PIMarker();
        pi3Marker.depth = 3;
        return pi3Marker;
      case "sp":
        return new SPMarker();
      case "ft":
        return new FTMarker();
      case "fr":
        return new FRMarker();
      case "fr*":
        return new FREndMarker();
      case "fk":
        return new FKMarker();
      case "fv":
        return new FVMarker();
      case "fv*":
        return new FVEndMarker();
      case "f*":
        return new FEndMarker();
      case "bd":
        return new BDMarker();
      case "bd*":
        return new BDEndMarker();
      case "it":
        return new ITMarker();
      case "it*":
        return new ITEndMarker();
      case "rem":
        return new REMMarker();
      case "b":
        return new BMarker();
      case "s":
      case "s1":
        return new SMarker();
      case "s2":
        const s2Marker = new SMarker();
        s2Marker.weight = 2;
        return s2Marker;
      case "s3":
        const s3Marker = new SMarker();
        s3Marker.weight = 3;
        return s3Marker;
      case "s4":
        const s4Marker = new SMarker();
        s4Marker.weight = 4;
        return s4Marker;
      case "s5":
        const s5Marker = new SMarker();
        s5Marker.weight = 5;
        return s5Marker;
      case "bk":
        return new BKMarker();
      case "bk*":
        return new BKEndMarker();
      case "li":
      case "li1":
        return new LIMarker();
      case "li2":
        const li2Marker = new LIMarker();
        li2Marker.depth = 2;
        return li2Marker;
      case "li3":
        const li3Marker = new LIMarker();
        li3Marker.depth = 3;
        return li3Marker;
      case "add":
        return new ADDMarker();
      case "add*":
        return new ADDEndMarker();
      case "tl":
        return new TLMarker();
      case "tl*":
        return new TLEndMarker();
      case "mi":
        return new MIMarker();
      case "sc":
        return new SCMarker();
      case "sc*":
        return new SCEndMarker();
      case "r":
        return new RMarker();
      case "rq":
        return new RQMarker();
      case "rq*":
        return new RQEndMarker();
      case "w":
        return new WMarker();
      case "w*":
        return new WEndMarker();
      case "x":
        return new XMarker();
      case "x*":
        return new XEndMarker();
      case "xo":
        return new XOMarker();
      case "xt":
        return new XTMarker();
      case "xq":
        return new XQMarker();
      case "pc":
        return new PCMarker();
      case "cls":
        return new CLSMarker();
      case "tr":
        return new TRMarker();
      case "th1":
        return new THMarker();
      case "thr1":
        return new THRMarker();
      case "th2":
        const th2Marker = new THMarker();
        th2Marker.columnPosition = 2;
        return th2Marker;
      case "thr2":
        const thr2Marker = new THRMarker();
        thr2Marker.columnPosition = 2;
        return thr2Marker;
      case "th3":
        const th3Marker = new THMarker();
        th3Marker.columnPosition = 3;
        return th3Marker;
      case "thr3":
        const thr3Marker = new THRMarker();
        thr3Marker.columnPosition = 3;
        return thr3Marker;
      case "tc1":
        return new TCMarker();
      case "tcr1":
        return new TCRMarker();
      case "tc2":
        const tc2Marker = new TCMarker();
        tc2Marker.columnPosition = 2;
        return tc2Marker;
      case "tcr2":
        const tcr2Marker = new TCRMarker();
        tcr2Marker.columnPosition = 2;
        return tcr2Marker;
      case "tc3":
        const tc3Marker = new TCMarker();
        tc3Marker.columnPosition = 3;
        return tc3Marker;
      case "tcr3":
        const tcr3Marker = new TCRMarker();
        tcr3Marker.columnPosition = 3;
        return tcr3Marker;
      case "usfm":
        return new USFMMarker();
      /* Character Styles */
      case "em":
        return new EMMarker();
      case "em*":
        return new EMEndMarker();
      case "bdit":
        return new BDITMarker();
      case "bdit*":
        return new BDITEndMarker();
      case "no":
        return new NOMarker();
      case "no*":
        return new NOEndMarker();
      case "k":
        return new KMarker();
      case "k*":
        return new KEndMarker();
      case "lf":
        return new LFMarker();
      case "lik":
        return new LIKMarker();
      case "lik*":
        return new LIKEndMarker();
      case "litl":
        return new LITLMarker();
      case "litl*":
        return new LITLEndMarker();
      case "liv":
        return new LIVMarker();
      case "liv*":
        return new LIVEndMarker();
      case "ord":
        return new ORDMarker();
      case "ord*":
        return new ORDEndMarker();
      case "pmc":
        return new PMCMarker();
      case "pmo":
        return new PMOMarker();
      case "pmr":
        return new PMRMarker();
      case "png":
        return new PNGMarker();
      case "png*":
        return new PNGEndMarker();
      case "pr":
        return new PRMarker();
      case "qt":
        return new QTMarker();
      case "qt*":
        return new QTEndMarker();
      case "rb":
        return new RBMarker();
      case "rb*":
        return new RBEndMarker();
      case "sig":
        return new SIGMarker();
      case "sig*":
        return new SIGEndMarker();
      case "sls":
        return new SLSMarker();
      case "sls*":
        return new SLSEndMarker();
      case "wa":
        return new WAMarker();
      case "wa*":
        return new WAEndMarker();
      case "wg":
        return new WGMarker();
      case "wg*":
        return new WGEndMarker();
      case "wh":
        return new WHMarker();
      case "wh*":
        return new WHEndMarker();
      case "wj":
        return new WJMarker();
      case "wj*":
        return new WJEndMarker();
      case "nd":
        return new NDMarker();
      case "nd*":
        return new NDEndMarker();
      case "sup":
        return new SUPMarker();
      case "sup*":
        return new SUPEndMarker();
      case "ie":
        return new IEMarker();
      case "pn":
        return new PNMarker();
      case "pn*":
        return new PNEndMarker();
      case "pro":
        return new PROMarker();
      case "pro*":
        return new PROEndMarker();

      /* Special Features */
      case "fig":
        return new FIGMarker();
      case "fig*":
        return new FIGEndMarker();

      default:
        const unknownMarker = new UnknownMarker();
        unknownMarker.parsedIdentifier = identifier;
        return unknownMarker;
    }
  }
}
